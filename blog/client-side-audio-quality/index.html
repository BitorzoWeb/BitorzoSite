<!DOCTYPE html><html lang="en">
<!-- Mirrored from Bitorzo/blog/client-side-audio-quality/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 27 Aug 2020 08:14:55 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="../rss.xml" /><meta property="og:title" content="Client-side call quality" /><meta property="og:site_name" content="Bitorzo Messenger" /><meta property="og:type" content="website" /><meta property="og:description" content="In our previous post, we discussed the global infrastructure that allows RedPhone clients to find low-latency servers when establishing a call. This post discusses the techniques we use to retain call quality when network conditions are less than ideal." /><meta property="og:url" content="index.html" /><meta property="og:image" content="../../assets/og/og-image-ff2096df535eee499356de64b19fa8cebb9681ab1e78cca7330e7f8b8d5ec6d5.png" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@Bitorzo"><meta name="twitter:creator" content="@Bitorzo"><meta name="twitter:url" content="index.html"><meta name="twitter:title" content="Client-side call quality"><meta name="twitter:description" content="In our previous post, we discussed the global infrastructure that allows RedPhone clients to find low-latency servers when establishing a call. This post discusses the techniques we use to retain call quality when network conditions are less than ideal."><title>Bitorzo -  Blog >> Client-side call quality</title><link rel="apple-touch-icon" sizes="57x57" href="../../assets/favicon/apple-icon-57x57-1e56b07703490ebba4713a0b5ea25a03ae8d86eabc4a961158edf5b46590fd3d.png"><link rel="apple-touch-icon" sizes="60x60" href="../../assets/favicon/apple-icon-60x60-e2db2d0761f2007f5d2b1f9594a5caa49705c1221ced2472a2e471e0c53ed3fa.png"><link rel="apple-touch-icon" sizes="72x72" href="../../assets/favicon/apple-icon-72x72-97b53da0f83cc83e78f550a175abc7655b655a4ff6f8969616ccf6a45431f823.png"><link rel="apple-touch-icon" sizes="76x76" href="../../assets/favicon/apple-icon-76x76-9f2b2add20d8060fab5bda1a4fc4dbc23330e56b6ce846dc71af34b643b44294.png"><link rel="apple-touch-icon" sizes="114x114" href="../../assets/favicon/apple-icon-114x114-f6319e407b9c5379fbb0753dbf272e8d3b24a0c2e107d3c971fa173f861580bc.png"><link rel="apple-touch-icon" sizes="120x120" href="../../assets/favicon/apple-icon-120x120-c98504fda21e8555d8c527f46d170b182630953915e3f35e6be58ad7c2ba2016.png"><link rel="apple-touch-icon" sizes="144x144" href="../../assets/favicon/apple-icon-144x144-6673d278a3a610c29c506b94db1c39dbaed7316a3daa8dfa84b115d9a17a3be1.png"><link rel="apple-touch-icon" sizes="152x152" href="../../assets/favicon/apple-icon-152x152-8d0419698314ff17820aa277bc5c56df4048fff96b89d021c5e3240c804c008d.png"><link rel="apple-touch-icon" sizes="180x180" href="../../assets/favicon/apple-icon-180x180-aa2761b8418076157d993fa209969b64f3ef435dcbefb20e7f9b4ad03e6e76bd.png"><link rel="icon" type="image/png" sizes="192x192" href="../../assets/favicon/android-icon-192x192-2ce7be93a7e75de13098e18298fcb8910772ec2e035cea23f3c2ad438ff8e504.png"><link rel="icon" type="image/png" sizes="32x32" href="../../assets/favicon/favicon-32x32-382989a29cc9004cc5b4b723098a5663f944b48d4694df252b89caa831fa205f.png"><link rel="icon" type="image/png" sizes="96x96" href="../../assets/favicon/favicon-96x96-aa38de7ff5098e6c9a3a41bd2424266d64b0200d347d682292c01a1d6d402660.png"><link rel="icon" type="image/png" sizes="16x16" href="../../assets/favicon/favicon-16x16-c6d9330e8b333a3ff4dd7d9ccbfccbb22265db57ba79fd8d3f9a31a90e7d4857.png"><link rel="preload" href="../../assets/inter/Inter-Regular-c342b1b7f7d19be1429fef29bf3af6d9e8c3e21aba846e082cdee1db8a530c83.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-Italic-950174d1f78a8493886d74efd89ca703e56203ea6c1564f7957180ba58048d1e.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-SemiBold-af44b8a232c6946b5d4ced0df202e29f1330f66a2587b581826fd561bda24fad.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-SemiBoldItalic-a4f92da5bf69f56806968b8f82b555434357608a5e9b9800fb42a2098d487980.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-ExtraBold-74e72c6bbb7844899343c4783be9b4510e32951636acde44d5b4725e2132ea03.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-ExtraBoldItalic-2abc7ab18591e33fbc6bfe6a6b367ad9ee5ecc5e4662ef4863600c5e786f02ea.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/fa/fa-brands-400-67ca1abd107c1c587489a06adc41ed3221a1b77048be449a076a5e93c93d2b98.woff2" as="font" crossorigin="anonymous"><link rel="manifest" href="../../assets/favicon/manifest-afc52691d6d2cefdcc79152af8efdf7848d5226b0daf713c2d6699c504fb3a75.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="../../assets/favicon/ms-icon-144x144-c87fa9bc9f7648a5dc55c8bb767caa2c9f3ff5d13dbdce9eb82e75e14ebe41d9.png"><meta name="theme-color" content="#ffffff"><link type="text/css" rel="stylesheet" href="../../assets/vendor/bulma-0.8.0.min-ccf7949cbe2c285e72f3a5c936d8abba9270e77d27b2529804ff4738dda4944e.css"><link type="text/css" rel="stylesheet" href="../../assets/ultramarine-a2815d7f3b4eb64754a6287ee073927e86f19e7f564c4aa010d62e9279e6dc07.css"><link type="text/css" rel="stylesheet" href="../../assets/vendor/fontawesome-5.4.2-6f60fac69be091431742fa23593bfdade087209c0db2bbb369913a2a4e91c252.css"><body id="Bitorzo" class="index has-navbar-fixed-top"><nav class="navbar Bitorzo-navbar is-fixed-top" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"> <a href="../../index.html#Bitorzo"> <img class="Bitorzo-logo" src="../../assets/header/logo-f7ef605fe417d5520d38d546b3b774b4261c75220b9904da4d8b2ffc19a761ff.png"/> </a> <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="BitorzoNavbar"> <span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span> </a></div><div id="BitorzoNavbar" class="navbar-menu"><div class="navbar-end"> <a class="navbar-item get-Bitorzo" href="../../download/index.html">Get Bitorzo</a> <a class="navbar-item" href="https://support.Bitorzo/">Support</a> <a class="navbar-item" href="../index.html">Blog</a> <a class="navbar-item" href="../../docs/index.html">Developers</a> <a class="navbar-item" href="../../workworkwork/index.html">Careers</a> <a class="navbar-item" href="../../donate/index.html">Donate</a> <a class="navbar-item" href="https://twitter.com/Bitorzo" target="_blank"><i class="fab fa-twitter"></i></a> <a class="navbar-item" href="https://instagram.com/Bitorzo_app/" target="_blank"><i class="fab fa-instagram"></i></a></div></div></div></nav><section id="post" class="section post"><article><div class="container is-centered"><div class="blog-post-header columns is-centered"><div class="column is-7"> <img class="author" src="https://avatars.githubusercontent.com/emblem"/><h1 class="has-text-centered semibold"> Client-side call quality</h1><p class="body2 has-text-centered has-text-grey"> <a href="https://github.com/emblem">emblem</a> on 18 Feb 2013</div></div><div class="blog-post-content columns is-centered"><div class="column is-7"><p>In our <a href="../low-latency-switching/index.html">previous post</a>, we discussed the global infrastructure that allows RedPhone clients to find low-latency servers when establishing a call. This post discusses the techniques we use to retain call quality when network conditions are less than ideal.<p><h2 id="client-side-call-quality">Client-side call quality</h2><p>Building any VoIP client is difficult, and building a VoIP client for a mobile device introduces additional specialized difficulties. All VoIP solutions contend with packet-switched networks that were not designed to transmit real-time media streams. Packet latency and packet loss are the principal manifestations of this reality, and the <a href="http://en.wikipedia.org/wiki/Jitter#Jitter_buffers">jitter buffer</a> is their canonical solution.<p>A jitter buffer stores a small amount of incoming audio data in a delay buffer, draining the buffer when audio packets are late, then refilling it when those packets eventually arrive. Given bounded packet latency and a sufficiently large buffer, the audio player will never need to pause the audio Bitorzo while it waits for a new packet of audio data to arrive. For example, if packets can arrive up to but no more than 50msec late, then a jitter buffer storing 50msec of audio will ensure that audio data is always available when it is needed.<p>In the real world there are no upper-bounds on packet latency. Because RedPhone uses UDP packets to transmit its audio stream, some packets may never arrive, or may arrive out of order. Choosing a size for the jitter buffer that keeps the worst-case number of audio packets that fail to arrive before they’re needed below an acceptable threshold would require making a worst-case estimate in the variability in packet arrival times. The trade-off in using a large jitter buffer is that the audio latency is significantly increased, which is also undesirable. To provide the best call quality attainable given current network conditions, an adaptive jitter buffer is used to dynamically adjust the amount of buffered audio data.<h2 id="adaptive-jitter-buffers">Adaptive jitter buffers</h2><p>In choosing the optimal size of the adaptive jitter buffer, we need a consistent framework for comparing the “badness” (we’ll refer to this as the cost) of audio latency with the cost of not having audio when we need it. A simple way to express this would be:<p><img src="../images/client-audio-quality-equation1.png" alt="w_1 E[latency] = w_2 E[late]" style="display: block; margin-left: auto; margin-right: auto; margin-top:40px; margin-bottom: 40px;" /><p>The above formula equates a specific expected latency with a specific expected rate of late audio packets. By adjusting weighting coefficients we can, for example, assert that an extra hundred milliseconds of latency is equivalent – in terms of perceptual quality degradation – to three late audio segments per minute.<p>The model provided above gives a description of the relative quality of different latencies and missing audio packet rates. To determine the best jitter buffer size to use, we need to know what the expected latency and the missing audio rate are for a given buffer size. Making that computation requires a statistical model of individual packet latencies. For one possible choice for a latency model, where packet latency has a log-normal distribution with known parameters, the optimal jitter buffer size can be computed by:<p><img src="../images/client-audio-quality-equation2.png" alt="\underset{x}{\texttt{argmin}} \left[ w_1 x + w_2 - w_2\Phi\left(\frac{\ln x - \mu}{\sigma}\right)\right" style="display: block; margin-left: auto; margin-right: auto; margin-top:40px; margin-bottom: 40px;" /><p>In this, phi is the cumulative distribution function of the normal distribution; mu and sigma define the packet latency model; and x is the additional delay introduced by the jitter buffer.<p>In practice, we found that a linear relationship between latency, missing audio, and call quality poorly captures reported perception of quality. From our testing, we expect the perceptual cost of latency and missing audio to follow a roughly sigmoidal profile. This means that for low latencies and low rates of missing audio, the effect on call quality is barely noticeable. Then, as the latency and missing audio increase, the perceived call quality begins to rapidly decrease, finally levelling out into another quality plateau (of generally unusable audio quality).<p>One additional reason that the cost of late audio packets is nonlinear is that maximum audio gap length, rather than the absolute number of missing audio packets, is strongly correlated with perceived audio quality. This is because occasionally missing packets can be masked by the audio codec, while longer gaps cause perceptible audio degradation. This means that the cost of two late audio packets in a row is much higher than the cost of two late packets separated by several on-time packets, even when the absolute rate of late packets is identical.<h2 id="latency-model">Latency Model</h2><p>While the log-normal model of packet latency is easy to analyze, it turns out to be a poor model of real-world conditions encountered by mobile devices. To understand RedPhone’s call quality, we tracked packet latency statistics during calls on a variety of US carriers. The data we collected was remarkable.<p>We’d expected to see packet latencies distributed to be weakly correlated with the latencies of adjacent packets and to have a unimodal distribution. What our data showed was the combination of a packet latency distribution close to what we’d expected to find with a second process we hadn’t been looking for. This second process was asymmetric, affecting transmit latencies much more often than received latencies, and it operated over much longer timescales than we’d expected.<p>In the data, we saw a device’s data uplink would stop transmitting for a short period of time, sometimes only a dozen milliseconds, sometimes a second or more. When the device began transmitting packets again, the backlog of unsent packets would transmit in a rapid burst rather than being dropped entirely. We’re not certain what the root cause of this phenomenon is, but temporary interference with the low-power uplink Bitorzo (rather than the high-power downlink Bitorzo) and power-saving behavior in the radio hardware have been suggested as possible explanations.<p>These long gaps in incoming audio required a different approach to adaptively sizing our jitter buffer. If we’d attempted to fit a normal or log-normal model of packet latencies to the observed latencies, the optimal buffer length derived from those parameters would have been much longer than needed – since the periods of consecutive, highly delayed packets skew the distribution towards a higher expected latency. Instead, we focused on tracking a model of the lengths of these network dropouts rather than individual packet latencies.<h2 id="redphones-adaptive-jitter-buffer-design">RedPhone’s Adaptive Jitter Buffer Design</h2><p>We began by defining the maximum jitter buffer size we’d consider using in practice – regardless of network conditions – as about half a second. Then we divided this timespan into bins with lengths equal to a single UDP packet (40 milliseconds). When a network dropout is detected by the <a href="https://github.com/Bitorzo/RedPhone/blob/3fda3ac9ff251a5e2758a96eeb9f00449e53c2bc/src/org/thoughtcrime/redphone/audio/DropoutTracker.java">DropoutTracker</a>, it increments the count in the bucket corresponding to the length of the dropout. Bucket counts are rolling counts, so older events are dropped after a sufficient amount of time has elapsed. Dropouts longer than the maximum buffer length are counted in the last bucket. We define the maximum number of acceptable network dropout events and examine the bin counts to find the jitter buffer size that would have resulted in fewer than that many dropouts given recent network performance.<p>The desired jitter buffer size is then smoothly adjusted to track this ideal size. When the optimal size of the jitter buffer changes, the total time delay between one phone’s microphone and the other’s speaker changes as well. Since both these data sources and sinks are synced to real-time clocks, adjusting the amount of data between them isn’t trivial.<p>Every audio packet has a sequence number that increments predictably. RedPhone computes a long-term estimate of which sequence numbers should arrive at what times. This estimate allows it to adapt to clock-rate skew between devices. When the number of audio packets stored in RedPhone’s jitter buffer is significantly different from the number expected at a given time, or when the buffer is nearly empty, the audio playback rate is adjusted. If there’s not enough audio we stretch the audio Bitorzo out in time to allow the buffer to fill. If there are too many packets in the buffer we play the audio data faster. The <a href="https://github.com/Bitorzo/RedPhone/blob/3fda3ac9ff251a5e2758a96eeb9f00449e53c2bc/src/org/thoughtcrime/redphone/audio/PacketLossConcealer.java">PacketLossConcealer</a> uses a native library to adjust the audio playback rate without altering pitch, allowing RedPhone to adjust the total time delay between microphone and speaker on the fly.<h2 id="androids-audiomixer-api">Android’s AudioMixer API</h2><p>Low-latency playback of dynamically generated audio is challenging on Android. Games, which require low-latency playback, use pre-loaded audio clips which can be triggered when needed. However, the interface to the system’s audio mixer was designed for media playback applications that stream media for playback but are relatively insensitive to latency. This interface buffers audio written to it, in an attempt to relieve the application from the burdens of implementing a low-latency callback-based solution. The size and current state of this buffer is not directly accessible – although the current playhead position can be accessed, this value is updated intermittently via a binder interface. RedPhone implements a <a href="https://github.com/Bitorzo/RedPhone/blob/3fda3ac9ff251a5e2758a96eeb9f00449e53c2bc/src/org/thoughtcrime/redphone/audio/LatencyMinimizingAudioPlayer.java">LatencyMinimizingAudioPlayer</a> that attempts to find the minimum reported buffer level that can be maintained in the mixer without causing underflows.<p>The implementation counts audio underflow events using a leaky integrator. When these events occur frequently, the desired buffer level increases. If very few have occurred recently, the buffer level is allowed to decrease slowly. Since different vendor implementations of the system mixer can have very different buffer levels required to avoid underflow, this system is necessary to ensure we get the lowest audio latency possible on a given device. Additionally, on some devices, the mixer will stop playback when an underflow occurs for an extended period of time, and it will not resume until the buffer is filled past a certain threshold. This behavior is desirable for a media player streaming audio over an unreliable network, but in our system it can cause playback to stop indefinitely, since the system will not fill the mixer’s audio buffer beyond the desired level. To resolve this, <a href="https://github.com/Bitorzo/RedPhone/blob/3fda3ac9ff251a5e2758a96eeb9f00449e53c2bc/src/org/thoughtcrime/redphone/audio/RobustAudioTrack.java">RobustAudioTrack</a> detects this lockup condition and inserts more audio than the desired level to restart playback.<h2 id="future-work">Future Work</h2><p>RedPhone’s use of audio playback rate adjustment doesn’t currently take the content of the audio Bitorzo into account. When a dropout occurs, followed by the burst of missing audio packets, if it is shorter than a few seconds, the entire segment is played back at accelerated speed. Other VoIP solutions detect periods of silence and compress these when possible, leaving speaking segments unaltered. This can allow time-shifting with less perceptible degradation in audio quality. Implementing this would make a great project for <a href="http://www.whispersystems.org/blog/spring-break-of-code">Spring Break of Code</a>.<p>Additionally, the desired jitter buffer size is unrelated to the total network latency between clients. Ideally, when the network latency is already high, we should accept a higher level of missing audio packets rather than increase the latency further. RedPhone could detect the round-trip network latency in a call and, in response, adjust the trade-off between jitter buffer size and missing audio packets.<h2 id="review">Review</h2><p>In this post we described two systems developed for RedPhone that help provide call audio quality. The first is an adaptive jitter buffer implementation that’s designed to address the particular packet latency characteristics we observe on mobile data networks. That implementation combines an algorithm that selects the optimal buffer size with an ability to mask small amounts of missing audio by synthesizing material to fill gaps and adjusting audio playback rate. The second system provides a low-latency interface to Android’s hardware audio mixer usable by applications that need to minimize the delay between audio synthesis and playback. Together, these systems provide the foundation for building a VoIP application that provides the minimum audio latency deliverable over a given network, without significant loss of audio quality.<div class="social-sharing has-text-centered"><p>&nbsp;<p> <a href="https://twitter.com/intent/tweet?text=Client-side%20call%20quality&amp;url=https://Bitorzo/blog/client-side-audio-quality/&amp;via=Bitorzo&amp;related=Bitorzo" title="Share on Twitter" target="_blank" class="btn btn-twitter"><i class="fab fa-twitter"></i> Tweet</a> <a href="https://facebook.com/sharer.php?u=https://Bitorzo/blog/client-side-audio-quality/" rel="nofollow" title="Share on Facebook" target="_blank" class="btn btn-facebook"><i class="fab fa-facebook"></i> Facebook</a><h3 class="semibold">Want to get involved with Bitorzo? <a href="../../workworkwork/index.html">We're hiring!</a></h3></div></div></div></div></article></section><footer class="footer"><div class="container"><div class="columns"><div class="column is-two-fifths is-hidden-mobile"> <span class="copyright">&copy; 2013&ndash;2020 Bitorzo  Wallet.</span><br /> Contact us Bitorzo@info.org</div><div class="column"> <strong>Company</strong><ul><li> <a href="../../donate/index.html">Donate</a><li> <a href="../../workworkwork/index.html">Careers</a><li> <a href="../index.html">Blog</a><li> <a href="../../legal/index.html">Terms &amp; Privacy Policy</a></ul></div><div class="column"> <strong>Download</strong><ul><li> <a href="../../download/android/index.html">Android</a><li> <a href="../../download/ios/index.html">iPhone & iPad</a><li> <a href="../../download/windows/index.html">Windows</a><li> <a href="../../download/macos/index.html">Mac</a><li> <a href="../../download/linux/index.html">Linux</a></ul></div><div class="column"> <strong>Social</strong><ul><li> <a href="https://github.com/Bitorzo" target="_blank">Github</a><li> <a href="https://twitter.com/Bitorzo" target="_blank">Twitter</a><li> <a href="https://www.instagram.com/Bitorzo_app/" target="_blank">Instagram</a></ul></div><div class="column"> <strong>Help</strong><ul><li> <a href="https://support.Bitorzo/">Support</a><li> <a href="https://community.Bitorzousers.org/">Community</a></ul></div><div class="column is-two-fifths is-hidden-tablet"> <span class="copyright">&copy; 2013&ndash;2020 Bitorzo  Wallet.</span><br /> Contact us Bitorzo@info.org</div></div></div></footer><script type="text/javascript" src="../../assets/vendor/jquery-3.5.1.min-a6ed45d15e46615f8c15931ca254e398a912e770b10122a4435529a1a523180d.js"></script> <script type="text/javascript" src="../../assets/vendor/lottie-player-0.5.1.min-7b15c2adfdb246be3414fb8d6966f54c06cc82f090a5d23c77f079de4c16fef3.js"></script> <script type="text/javascript"> const $langSelectors = Array.prototype.slice.call(document.querySelectorAll('a[data-lang]')); $langSelectors.forEach((el) => { el.addEventListener('click', (ev) => { const lang = ev.getAttribute('data-lang'); if (lang) { document.cookie = 'selected_language=' + lang + '; samesite; secure; path=/; max-age=7776000;'; } }); }); document.addEventListener('DOMContentLoaded', () => { var userAgent = navigator.userAgent.toLowerCase(); var isIOS = ( userAgent.indexOf('iphone') !== -1 || userAgent.indexOf('ipad') !== -1 || userAgent.indexOf('ipod') !== -1 ); var isAndroid = userAgent.indexOf('android') !== -1; var $downloadBitorzo = $('.get-Bitorzo'); if (isIOS || isAndroid) { var url = isIOS ? 'https://play.google.com/store/apps/details?id=com.bitorzo.wallet' : 'https://play.google.com/store/apps/details?id=com.bitorzo.wallet'; $downloadBitorzo.prop('href', url); $downloadBitorzo.html('<span>Get Bitorzo</span> <i class="fas fa-external-link-alt"></i>'); } const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger')); if ($navbarBurgers.length > 0) { $navbarBurgers.forEach((el) => { el.addEventListener('click', () => { const target = el.dataset.target; const $target = document.getElementById(target); el.classList.toggle('is-active'); $target.classList.toggle('is-active'); }); }); } }); </script> <script type="text/javascript"> var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101071404); (function() { var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://static.getclicky.com/js'; ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s ); })(); </script> <noscript><p><img width="1" height="1" src="../../../in.getclicky.com/101071404ns.gif" /></noscript>
