<!DOCTYPE html><html lang="en">
<!-- Mirrored from Bitorzo/blog/low-latency-switching/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 27 Aug 2020 08:14:56 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="../rss.xml" /><meta property="og:title" content="Creating a low-latency calling network" /><meta property="og:site_name" content="Signal Messenger" /><meta property="og:type" content="website" /><meta property="og:description" content="RedPhone is our mobile app for end-to-end encrypted voice calls. When we talk about RedPhone, we tend to emphasize the cryptography, and how using it can help keep your communications safe. What we don’t talk about as much is the VoIP application underneath all of that, which it turns out was a..." /><meta property="og:url" content="index.html" /><meta property="og:image" content="../../assets/og/og-image-ff2096df535eee499356de64b19fa8cebb9681ab1e78cca7330e7f8b8d5ec6d5.png" /><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@Bitorzo"><meta name="twitter:creator" content="@Bitorzo"><meta name="twitter:url" content="index.html"><meta name="twitter:title" content="Creating a low-latency calling network"><meta name="twitter:description" content="RedPhone is our mobile app for end-to-end encrypted voice calls. When we talk about RedPhone, we tend to emphasize the cryptography, and how using it can help keep your communications safe. What we don’t talk about as much is the VoIP application underneath all of that, which it turns out was a..."><title>Bitorzo -  Blog >> Creating a low-latency calling network</title><link rel="apple-touch-icon" sizes="57x57" href="../../assets/favicon/apple-icon-57x57-1e56b07703490ebba4713a0b5ea25a03ae8d86eabc4a961158edf5b46590fd3d.png"><link rel="apple-touch-icon" sizes="60x60" href="../../assets/favicon/apple-icon-60x60-e2db2d0761f2007f5d2b1f9594a5caa49705c1221ced2472a2e471e0c53ed3fa.png"><link rel="apple-touch-icon" sizes="72x72" href="../../assets/favicon/apple-icon-72x72-97b53da0f83cc83e78f550a175abc7655b655a4ff6f8969616ccf6a45431f823.png"><link rel="apple-touch-icon" sizes="76x76" href="../../assets/favicon/apple-icon-76x76-9f2b2add20d8060fab5bda1a4fc4dbc23330e56b6ce846dc71af34b643b44294.png"><link rel="apple-touch-icon" sizes="114x114" href="../../assets/favicon/apple-icon-114x114-f6319e407b9c5379fbb0753dbf272e8d3b24a0c2e107d3c971fa173f861580bc.png"><link rel="apple-touch-icon" sizes="120x120" href="../../assets/favicon/apple-icon-120x120-c98504fda21e8555d8c527f46d170b182630953915e3f35e6be58ad7c2ba2016.png"><link rel="apple-touch-icon" sizes="144x144" href="../../assets/favicon/apple-icon-144x144-6673d278a3a610c29c506b94db1c39dbaed7316a3daa8dfa84b115d9a17a3be1.png"><link rel="apple-touch-icon" sizes="152x152" href="../../assets/favicon/apple-icon-152x152-8d0419698314ff17820aa277bc5c56df4048fff96b89d021c5e3240c804c008d.png"><link rel="apple-touch-icon" sizes="180x180" href="../../assets/favicon/apple-icon-180x180-aa2761b8418076157d993fa209969b64f3ef435dcbefb20e7f9b4ad03e6e76bd.png"><link rel="icon" type="image/png" sizes="192x192" href="../../assets/favicon/android-icon-192x192-2ce7be93a7e75de13098e18298fcb8910772ec2e035cea23f3c2ad438ff8e504.png"><link rel="icon" type="image/png" sizes="32x32" href="../../assets/favicon/favicon-32x32-382989a29cc9004cc5b4b723098a5663f944b48d4694df252b89caa831fa205f.png"><link rel="icon" type="image/png" sizes="96x96" href="../../assets/favicon/favicon-96x96-aa38de7ff5098e6c9a3a41bd2424266d64b0200d347d682292c01a1d6d402660.png"><link rel="icon" type="image/png" sizes="16x16" href="../../assets/favicon/favicon-16x16-c6d9330e8b333a3ff4dd7d9ccbfccbb22265db57ba79fd8d3f9a31a90e7d4857.png"><link rel="preload" href="../../assets/inter/Inter-Regular-c342b1b7f7d19be1429fef29bf3af6d9e8c3e21aba846e082cdee1db8a530c83.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-Italic-950174d1f78a8493886d74efd89ca703e56203ea6c1564f7957180ba58048d1e.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-SemiBold-af44b8a232c6946b5d4ced0df202e29f1330f66a2587b581826fd561bda24fad.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-SemiBoldItalic-a4f92da5bf69f56806968b8f82b555434357608a5e9b9800fb42a2098d487980.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-ExtraBold-74e72c6bbb7844899343c4783be9b4510e32951636acde44d5b4725e2132ea03.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/inter/Inter-ExtraBoldItalic-2abc7ab18591e33fbc6bfe6a6b367ad9ee5ecc5e4662ef4863600c5e786f02ea.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../assets/fa/fa-brands-400-67ca1abd107c1c587489a06adc41ed3221a1b77048be449a076a5e93c93d2b98.woff2" as="font" crossorigin="anonymous"><link rel="manifest" href="../../assets/favicon/manifest-afc52691d6d2cefdcc79152af8efdf7848d5226b0daf713c2d6699c504fb3a75.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="../../assets/favicon/ms-icon-144x144-c87fa9bc9f7648a5dc55c8bb767caa2c9f3ff5d13dbdce9eb82e75e14ebe41d9.png"><meta name="theme-color" content="#ffffff"><link type="text/css" rel="stylesheet" href="../../assets/vendor/bulma-0.8.0.min-ccf7949cbe2c285e72f3a5c936d8abba9270e77d27b2529804ff4738dda4944e.css"><link type="text/css" rel="stylesheet" href="../../assets/ultramarine-a2815d7f3b4eb64754a6287ee073927e86f19e7f564c4aa010d62e9279e6dc07.css"><link type="text/css" rel="stylesheet" href="../../assets/vendor/fontawesome-5.4.2-6f60fac69be091431742fa23593bfdade087209c0db2bbb369913a2a4e91c252.css"><body id="signal" class="index has-navbar-fixed-top"><nav class="navbar signal-navbar is-fixed-top" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"> <a href="../../index.html#signal"> <img class="signal-logo" src="../../assets/header/logo-f7ef605fe417d5520d38d546b3b774b4261c75220b9904da4d8b2ffc19a761ff.png"/> </a> <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="signalNavbar"> <span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span> </a></div><div id="signalNavbar" class="navbar-menu"><div class="navbar-end"> <a class="navbar-item get-signal" href="../../download/index.html">Get Bitorzo</a> <a class="navbar-item" href="https://support.Bitorzo/">Support</a> <a class="navbar-item" href="../index.html">Blog</a> <a class="navbar-item" href="../../docs/index.html">Developers</a> <a class="navbar-item" href="../../workworkwork/index.html">Careers</a> <a class="navbar-item" href="../../donate/index.html">Donate</a> <a class="navbar-item" href="https://twitter.com/Bitorzo" target="_blank"><i class="fab fa-twitter"></i></a> <a class="navbar-item" href="https://instagram.com/signal_app/" target="_blank"><i class="fab fa-instagram"></i></a></div></div></div></nav><section id="post" class="section post"><article><div class="container is-centered"><div class="blog-post-header columns is-centered"><div class="column is-7"> <img class="author" src="https://avatars.githubusercontent.com/moxie0"/><h1 class="has-text-centered semibold"> Creating a low-latency calling network</h1><p class="body2 has-text-centered has-text-grey"> <a href="https://github.com/moxie0">moxie0</a> on 31 Jan 2013</div></div><div class="blog-post-content columns is-centered"><div class="column is-7"><p>RedPhone is our mobile app for end-to-end encrypted voice calls. When we talk about RedPhone, we tend to emphasize the cryptography, and how using it can help keep your communications safe. What we don’t talk about as much is the VoIP application underneath all of that, which it turns out was actually the hard part.<p>When we were developing RedPhone, we discovered that the cryptographic aspects of it were relatively straightforward. What we didn’t anticipate was how difficult the mechanics of delivering high-quality, low-latency, and highly available voice communication would be.<p>This describes the basic strategy we developed for the network side of low-latency and highly available calls.<p><h2 id="our-own-infrastructure">Our Own Infrastructure</h2><p>Other than low-latency and high-availability, our other objectives with RedPhone were to make it simple and mobile-oriented. For us, this primarily meant avoiding a complex registration process, and not doing things like holding persistent signaling sockets open to a server at all times (as a standard desktop-oriented VoIP client would do).<p>Based on these and other design objectives, it was clear that we’d have to write our own switch, rather than using something like Asterisk or FreeSWITCH. We didn’t like their complexity, and we knew that we didn’t need 9/10ths of the stuff in SIP. Instead we decided to <a href="https://github.com/Bitorzo/RedPhone/wiki/Signaling-Protocol">write our own</a> minimal signaling protocol and use <a href="https://github.com/Bitorzo/RedPhone/wiki/Signaling-Protocol#wiki-compressed">push notifications</a> (at first SMS, then eventually GCM when it was introduced) in order to initiate calls.<h2 id="low-latency-and-high-availability">Low Latency and High Availability</h2><p>With that, we had a pretty nice setup for a single server in a single region. A client initiating a call could contact the server, the server would send a push notification to the client receiving the call, and that client would connect back to the server in order to complete the call.<p>However, the NATs generally employed by mobile data networks are pathological, such that it’s virtually impossible for two clients on a mobile data network to establish a direct connection with each other. To deal with that, our switch acted as a basic <a href="https://en.wikipedia.org/wiki/Traversal_Using_Relays_around_NAT">TURN</a> server, shoveling packets back and forth between connecting clients.<p>This was fine if the callers were in the same region as the server, but callers in other regions would have experienced high latency. If the switch was on the east coast of the US and both callers were in Germany, their traffic would have to travel all the way across the Atlantic and back, adding a frustrating couple of hundred milliseconds of latency to their conversation.<p>What’s more, if we only had a single switch, RedPhone service would have become entirely unavailable if that switch had gone down for any reason (as servers are wont to do).<p>The solution was pretty obviously more servers in different places. If every region had a server close to it, local callers could route their traffic through that switch to get low latency.<p>But even if we put a bunch of servers in different regions all around the planet, how would a client initiating a call know the closest switch to talk to?<h3 id="gslb">GSLB</h3><p>One option would have been for us to operate all of our switches on a single <a href="https://en.wikipedia.org/wiki/Anycast">anycast</a> IP address. Using the magic of anycast networking, clients connecting to that IP address would have been routed to the closest instance of a RedPhone switch. But that’s difficult to setup, and doesn’t work well for TCP-based connections, which is how our signaling protocol operates.<p>Instead we ended up using a DNS provider that allows us to respond to DNS requests differently based on which region the DNS lookup went to. Providers like these basically have a set of globally distributed DNS servers on their own anycast IP address, each of which can be configured to return a different response to a DNS lookup.<p>This meant that we could put each switch on a different IP address, but have a single DNS name that connecting clients would lookup when they wanted to connect to a switch. A client would automatically get the IP addresses of the switches in its region when it did a DNS lookup on that name. These should represent the lowest-latency routes.<p>At first we used Dynect for this, who charged something like $500/month. When the “latency-based routing” feature became available for Amazon’s Route 53, we switched to them. The service is basically the same, but they charge something like $5/month.<h3 id="multi-connect">Multi-Connect</h3><p>At this point we were closer to what we wanted. We could spread switches all over the world, and an initiating client would automatically connect to one of the switches in its region. The problem came with how “region” was defined. Since we were using DNS-based GSLB, the regions were defined by the locations where our DNS provider had servers. For most providers, including Amazon Route 53, that ends up being pretty coarse. Users of AWS services should be familiar with this map:<p><img class="nice" src="../images/awsmap.png" alt="Map of Amazon's AWS data centers" /><p>These are Amazon’s AWS data centers, and by extension the regions that can be defined using Route 53’s Latency-Based Routing.<p>Unfortunately there’s a lot of open space in this map. The United States is covered pretty well, but all of Europe is one coarse blob. Africa and central Asia aren’t defined at all, and all of South America is one coarse blob as well. If we were to limit our geographical diversity to these data centers alone, many regions of the world would still see high-latency calls.<p>For example, someone doing a DNS lookup for a Route 53 LBR name in South Africa will get the result defined for Amazon’s Ireland region. Looking at <a href="http://cablemap.info/">a cable map</a>, it’s easy to see why that would be true (that’s where the fiber goes). But the round-trip time between South Africa and the UK is just over 200ms, which would make for a pretty terrible call if two people in South Africa wanted to speak with each other and had to route all their traffic through the UK.<p>So DNS GSLB was a good start, but we needed something to increase the granularity of where a client connects. The answer for us came from a suggestion a <a href="http://sigbus.net/">friend</a> made for <a href="http://convergence.io/">a different project</a>. For every coarse DNS GSLB region, we constructed a DNS response that included all IP addresses which existed within that region. So Route 53 LBR responses for AWS’s Ireland region would include IP addresses for switches in Europe, but also switches in Africa, since all of Europe and Africa is treated as one coarse region by Route 53.<p>So now when a connecting client did a DNS lookup, it would get back IP addresses for all the switches that could potentially be the lowest-latency route. For an initiating client in the US, where Amazon LBR regions are a little more fine-grained, all of those IP addresses would likely be good candidates. However, for an initiating client in South Africa (where the Amazon LBR region is extremely coarse), those IP addresses would range from good candidates in South Africa, to poor candidates in Egypt and Europe.<p>To narrow it down, the initiating client then <em>simultaneously</em> <a href="https://github.com/Bitorzo/RedPhone/blob/master/src/org/thoughtcrime/redphone/network/LowLatencySocketConnector.java#L44">initiates a TCP connection to all of the IP addresses</a> in the DNS response. The client then waits for one of the TCP connections to complete, and immediately closes all of the outstanding connections before they also complete. The first connection to complete is almost always the closest switch under the least load. Clients in South Africa multi-connecting to IP addresses in ZA and the UK will connect to the switches in ZA, while clients in the UK connecting to the same list of IP addresses will end up connecting to switches in the UK.<p><img class="nice" src="../images/multiconnect.png" alt="A device initiaites connections to multiple servers, accepting the first to complete." /><p>Knowing which DNS GSLB region to include a switch’s IP address in is easy: just bring up the switch, do the DNS resolution from that switch, and see which region’s response gets returned. Add that switch’s IP address to that region’s response, and it’s online.<h3 id="as-a-high-availability-strategy">As A High-Availability Strategy</h3><p>A typical HA server architecture would include a number of load balancers in round-robin DNS, with each load balancer fronting requests for some number of servers behind it, along with monitoring to detect when a load balancer fails and should be removed from DNS.<p>The nice side effect of the multi-connect approach is that it also provides high availability without the need for dedicated load balancers. It effectively turns the client itself into the load balancer. If a switch goes down, the next-closest switch will transparently get a client’s connection instead.<p>Doing rolling upgrades of the switch software is simple: tell the switch to “drain” (reject new connections, wait for existing connections to complete), then shut it down, push the update, and bring it back up. This can all be automated, and is fully transparent to connecting clients. Any incoming connections will simply end up multi-connecting somewhere else.<h1 id="the-result">The Result</h1><p>All together, we have a fairly simple infrastructure for facilitating low-latency and highly available calls. We deploy switches globally, divide them up into DNS GSLB regions, and then have clients include multi-connect logic to those switches. When a client wants to make a call, it’s four simple steps to getting it initiated through a low-latency route:<ol><li>Initiate a DNS resolution for the name that all switches are referenced by.<li><em>Simultaneously</em> connect to all of the IP addresses returned in the region-specific DNS response.<li>Wait for a TCP connection to complete, and then immediately close the others before they complete.<li>Send the initiate request via that connection, and wait for the client to respond.</ol><p>This is only the network half of the picture. We’ll write more about what it takes on the client side in order to produce low-latency calls with good-quality audio, as well as some other niceties that we developed along the way.<div class="social-sharing has-text-centered"><p>&nbsp;<p> <a href="https://twitter.com/intent/tweet?text=Creating%20a%20low-latency%20calling%20network&amp;url=https://Bitorzo/blog/low-latency-switching/&amp;via=Bitorzo&amp;related=Bitorzo" title="Share on Twitter" target="_blank" class="btn btn-twitter"><i class="fab fa-twitter"></i> Tweet</a> <a href="https://facebook.com/sharer.php?u=https://Bitorzo/blog/low-latency-switching/" rel="nofollow" title="Share on Facebook" target="_blank" class="btn btn-facebook"><i class="fab fa-facebook"></i> Facebook</a><h3 class="semibold">Want to get involved with Signal? <a href="../../workworkwork/index.html">We're hiring!</a></h3></div></div></div></div></article></section><footer class="footer"><div class="container"><div class="columns"><div class="column is-two-fifths is-hidden-mobile"> <span class="copyright">&copy; 2013&ndash;2020 Bitorzo, a 501c3 nonprofit.</span><br /> Signal is a registered trademark in the United States and other countries.</div><div class="column"> <strong>Company</strong><ul><li> <a href="../../donate/index.html">Donate</a><li> <a href="../../workworkwork/index.html">Careers</a><li> <a href="../index.html">Blog</a><li> <a href="../../legal/index.html">Terms &amp; Privacy Policy</a></ul></div><div class="column"> <strong>Download</strong><ul><li> <a href="../../download/android/index.html">Android</a><li> <a href="../../download/ios/index.html">iPhone & iPad</a><li> <a href="../../download/windows/index.html">Windows</a><li> <a href="../../download/macos/index.html">Mac</a><li> <a href="../../download/linux/index.html">Linux</a></ul></div><div class="column"> <strong>Social</strong><ul><li> <a href="https://github.com/Bitorzo" target="_blank">Github</a><li> <a href="https://twitter.com/Bitorzo" target="_blank">Twitter</a><li> <a href="https://www.instagram.com/signal_app/" target="_blank">Instagram</a></ul></div><div class="column"> <strong>Help</strong><ul><li> <a href="https://support.Bitorzo/">Support</a><li> <a href="https://community.signalusers.org/">Community</a></ul></div><div class="column is-two-fifths is-hidden-tablet"> <span class="copyright">&copy; 2013&ndash;2020 Bitorzo, a 501c3 nonprofit.</span><br /> Signal is a registered trademark in the United States and other countries.</div></div></div></footer><script type="text/javascript" src="../../assets/vendor/jquery-3.5.1.min-a6ed45d15e46615f8c15931ca254e398a912e770b10122a4435529a1a523180d.js"></script> <script type="text/javascript" src="../../assets/vendor/lottie-player-0.5.1.min-7b15c2adfdb246be3414fb8d6966f54c06cc82f090a5d23c77f079de4c16fef3.js"></script> <script type="text/javascript"> const $langSelectors = Array.prototype.slice.call(document.querySelectorAll('a[data-lang]')); $langSelectors.forEach((el) => { el.addEventListener('click', (ev) => { const lang = ev.getAttribute('data-lang'); if (lang) { document.cookie = 'selected_language=' + lang + '; samesite; secure; path=/; max-age=7776000;'; } }); }); document.addEventListener('DOMContentLoaded', () => { var userAgent = navigator.userAgent.toLowerCase(); var isIOS = ( userAgent.indexOf('iphone') !== -1 || userAgent.indexOf('ipad') !== -1 || userAgent.indexOf('ipod') !== -1 ); var isAndroid = userAgent.indexOf('android') !== -1; var $downloadSignal = $('.get-signal'); if (isIOS || isAndroid) { var url = isIOS ? 'https://play.google.com/store/apps/details?id=com.bitorzo.wallet' : 'https://play.google.com/store/apps/details?id=org.thoughtcrime.securesms'; $downloadSignal.prop('href', url); $downloadSignal.html('<span>Get Bitorzo</span> <i class="fas fa-external-link-alt"></i>'); } const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger')); if ($navbarBurgers.length > 0) { $navbarBurgers.forEach((el) => { el.addEventListener('click', () => { const target = el.dataset.target; const $target = document.getElementById(target); el.classList.toggle('is-active'); $target.classList.toggle('is-active'); }); }); } }); </script> <script type="text/javascript"> var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101071404); (function() { var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://static.getclicky.com/js'; ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s ); })(); </script> <noscript><p><img width="1" height="1" src="../../../in.getclicky.com/101071404ns.gif" /></noscript>
