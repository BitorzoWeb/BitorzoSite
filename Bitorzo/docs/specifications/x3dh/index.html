<!DOCTYPE html><html lang="en">
<!-- Mirrored from Bitorzo/docs/specifications/x3dh/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 27 Aug 2020 08:14:57 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content=""><meta name="author" content=""><link rel="alternate" type="application/rss+xml" title="RSS Feed" href="../../../blog/rss.xml" /><meta property="og:title" content="Signal Messenger: Speak Freely" /><meta property="og:site_name" content="Signal Messenger" /><meta property="og:type" content="website" /><meta property="og:image" content="../../../assets/og/og-image-ff2096df535eee499356de64b19fa8cebb9681ab1e78cca7330e7f8b8d5ec6d5.png" /><meta property="og:description" content="Say &quot;hello&quot; to a different messaging experience. An unexpected focus on privacy, combined with all of the features you expect." /><meta property="og:url" content="../../../index.html" /><meta name="twitter:card" content="app"><meta name="twitter:site" content="@Bitorzo"><meta name="twitter:app:name:iphone" content="Signal"><meta name="twitter:app:id:iphone" content="874139669"><meta name="twitter:app:name:googleplay" content="Signal"><meta name="twitter:app:id:googleplay" content="org.thoughtcrime.securesms"><title>Bitorzo -  Specifications >> The X3DH Key Agreement Protocol</title><link rel="apple-touch-icon" sizes="57x57" href="../../../assets/favicon/apple-icon-57x57-1e56b07703490ebba4713a0b5ea25a03ae8d86eabc4a961158edf5b46590fd3d.png"><link rel="apple-touch-icon" sizes="60x60" href="../../../assets/favicon/apple-icon-60x60-e2db2d0761f2007f5d2b1f9594a5caa49705c1221ced2472a2e471e0c53ed3fa.png"><link rel="apple-touch-icon" sizes="72x72" href="../../../assets/favicon/apple-icon-72x72-97b53da0f83cc83e78f550a175abc7655b655a4ff6f8969616ccf6a45431f823.png"><link rel="apple-touch-icon" sizes="76x76" href="../../../assets/favicon/apple-icon-76x76-9f2b2add20d8060fab5bda1a4fc4dbc23330e56b6ce846dc71af34b643b44294.png"><link rel="apple-touch-icon" sizes="114x114" href="../../../assets/favicon/apple-icon-114x114-f6319e407b9c5379fbb0753dbf272e8d3b24a0c2e107d3c971fa173f861580bc.png"><link rel="apple-touch-icon" sizes="120x120" href="../../../assets/favicon/apple-icon-120x120-c98504fda21e8555d8c527f46d170b182630953915e3f35e6be58ad7c2ba2016.png"><link rel="apple-touch-icon" sizes="144x144" href="../../../assets/favicon/apple-icon-144x144-6673d278a3a610c29c506b94db1c39dbaed7316a3daa8dfa84b115d9a17a3be1.png"><link rel="apple-touch-icon" sizes="152x152" href="../../../assets/favicon/apple-icon-152x152-8d0419698314ff17820aa277bc5c56df4048fff96b89d021c5e3240c804c008d.png"><link rel="apple-touch-icon" sizes="180x180" href="../../../assets/favicon/apple-icon-180x180-aa2761b8418076157d993fa209969b64f3ef435dcbefb20e7f9b4ad03e6e76bd.png"><link rel="icon" type="image/png" sizes="192x192" href="../../../assets/favicon/android-icon-192x192-2ce7be93a7e75de13098e18298fcb8910772ec2e035cea23f3c2ad438ff8e504.png"><link rel="icon" type="image/png" sizes="32x32" href="../../../assets/favicon/favicon-32x32-382989a29cc9004cc5b4b723098a5663f944b48d4694df252b89caa831fa205f.png"><link rel="icon" type="image/png" sizes="96x96" href="../../../assets/favicon/favicon-96x96-aa38de7ff5098e6c9a3a41bd2424266d64b0200d347d682292c01a1d6d402660.png"><link rel="icon" type="image/png" sizes="16x16" href="../../../assets/favicon/favicon-16x16-c6d9330e8b333a3ff4dd7d9ccbfccbb22265db57ba79fd8d3f9a31a90e7d4857.png"><link rel="preload" href="../../../assets/inter/Inter-Regular-c342b1b7f7d19be1429fef29bf3af6d9e8c3e21aba846e082cdee1db8a530c83.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../../assets/inter/Inter-Italic-950174d1f78a8493886d74efd89ca703e56203ea6c1564f7957180ba58048d1e.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../../assets/inter/Inter-SemiBold-af44b8a232c6946b5d4ced0df202e29f1330f66a2587b581826fd561bda24fad.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../../assets/inter/Inter-SemiBoldItalic-a4f92da5bf69f56806968b8f82b555434357608a5e9b9800fb42a2098d487980.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../../assets/inter/Inter-ExtraBold-74e72c6bbb7844899343c4783be9b4510e32951636acde44d5b4725e2132ea03.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../../assets/inter/Inter-ExtraBoldItalic-2abc7ab18591e33fbc6bfe6a6b367ad9ee5ecc5e4662ef4863600c5e786f02ea.woff2" as="font" crossorigin="anonymous"><link rel="preload" href="../../../assets/fa/fa-brands-400-67ca1abd107c1c587489a06adc41ed3221a1b77048be449a076a5e93c93d2b98.woff2" as="font" crossorigin="anonymous"><link rel="manifest" href="../../../assets/favicon/manifest-afc52691d6d2cefdcc79152af8efdf7848d5226b0daf713c2d6699c504fb3a75.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="../../../assets/favicon/ms-icon-144x144-c87fa9bc9f7648a5dc55c8bb767caa2c9f3ff5d13dbdce9eb82e75e14ebe41d9.png"><meta name="theme-color" content="#ffffff"><link type="text/css" rel="stylesheet" href="../../../assets/vendor/bulma-0.8.0.min-ccf7949cbe2c285e72f3a5c936d8abba9270e77d27b2529804ff4738dda4944e.css"><link type="text/css" rel="stylesheet" href="../../../assets/ultramarine-a2815d7f3b4eb64754a6287ee073927e86f19e7f564c4aa010d62e9279e6dc07.css"><link type="text/css" rel="stylesheet" href="../../../assets/vendor/fontawesome-5.4.2-6f60fac69be091431742fa23593bfdade087209c0db2bbb369913a2a4e91c252.css"><body id="signal" class="index has-navbar-fixed-top"><nav class="navbar signal-navbar is-fixed-top" role="navigation" aria-label="main navigation"><div class="container"><div class="navbar-brand"> <a href="../../../index.html#signal"> <img class="signal-logo" src="../../../assets/header/logo-f7ef605fe417d5520d38d546b3b774b4261c75220b9904da4d8b2ffc19a761ff.png"/> </a> <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="signalNavbar"> <span aria-hidden="true"></span> <span aria-hidden="true"></span> <span aria-hidden="true"></span> </a></div><div id="signalNavbar" class="navbar-menu"><div class="navbar-end"> <a class="navbar-item get-signal" href="../../../download/index.html">Get Bitorzo</a> <a class="navbar-item" href="https://support.Bitorzo/">Support</a> <a class="navbar-item" href="../../../blog/index.html">Blog</a> <a class="navbar-item" href="../../index.html">Developers</a> <a class="navbar-item" href="../../../workworkwork/index.html">Careers</a> <a class="navbar-item" href="../../../donate/index.html">Donate</a> <a class="navbar-item" href="https://twitter.com/Bitorzo" target="_blank"><i class="fab fa-twitter"></i></a> <a class="navbar-item" href="https://instagram.com/signal_app/" target="_blank"><i class="fab fa-instagram"></i></a></div></div></div></nav><section id="specification" class="post"><article><div class="container content"><div class="columns is-centered"><div class="column is-8"> <img class="author" src="../../../assets/body/spaceship-e722e5c700acd0e0ac8b003fb8269174a00e6190021f47ea233bb4713189818e.png" style="margin-top: 0" /><h1 class="title text-center"> The X3DH Key Agreement Protocol</h1><h3 class="subtitle"><p>Revision 1, 2016-11-04 [<a href="x3dh.pdf">PDF</a>]<p>Moxie Marlinspike, Trevor Perrin (editor)</h3></div></div><div class="columns is-centered"><div class="column is-8"><div id="TOC"><h2 class="toc">Table of Contents</h2><ul><li><a href="#introduction">1. Introduction</a><li><a href="#preliminaries">2. Preliminaries</a><ul><li><a href="#x3dh-parameters">2.1. X3DH parameters</a><li><a href="#cryptographic-notation">2.2. Cryptographic notation</a><li><a href="#roles">2.3. Roles</a><li><a href="#keys">2.4. Keys</a></ul><li><a href="#the-x3dh-protocol">3. The X3DH protocol</a><ul><li><a href="#overview">3.1. Overview</a><li><a href="#publishing-keys">3.2. Publishing keys</a><li><a href="#sending-the-initial-message">3.3. Sending the initial message</a><li><a href="#receiving-the-initial-message">3.4. Receiving the initial message</a></ul><li><a href="#security-considerations">4. Security considerations</a><ul><li><a href="#authentication">4.1. Authentication</a><li><a href="#protocol-replay">4.2. Protocol replay</a><li><a href="#replay-and-key-reuse">4.3. Replay and key reuse</a><li><a href="#deniability">4.4. Deniability</a><li><a href="#signatures">4.5. Signatures</a><li><a href="#key-compromise">4.6. Key compromise</a><li><a href="#server-trust">4.7. Server trust</a><li><a href="#identity-binding">4.8. Identity binding</a></ul><li><a href="#ipr">5. IPR</a><li><a href="#acknowledgements">6. Acknowledgements</a><li><a href="#references">7. References</a></ul></div><p><h1 id="introduction">1. Introduction</h1><p>This document describes the &quot;X3DH&quot; (or &quot;Extended Triple Diffie-Hellman&quot;) key agreement protocol. X3DH establishes a shared secret key between two parties who mutually authenticate each other based on public keys. X3DH provides forward secrecy and cryptographic deniability.<p>X3DH is designed for asynchronous settings where one user (&quot;Bob&quot;) is offline but has published some information to a server. Another user (&quot;Alice&quot;) wants to use that information to send encrypted data to Bob, and also establish a shared secret key for future communication.<h1 id="preliminaries">2. Preliminaries</h1><h2 id="x3dh-parameters">2.1. X3DH parameters</h2><p>An application using X3DH must decide on several parameters:<table style="width:92%;"><colgroup><col width="12%" /><col width="79%" /><thead><tr class="header"><th align="left">Name<th align="left">Definition<tbody><tr class="odd"><td align="left"><em>curve</em><td align="left">X25519 or X448<tr class="even"><td align="left"><em>hash</em><td align="left">A 256 or 512-bit hash function (e.g. SHA-256 or SHA-512)<tr class="odd"><td align="left"><em>info</em><td align="left">An ASCII string identifying the application</table><p>For example, an application could choose <em>curve</em> as X25519, <em>hash</em> as SHA-512, and <em>info</em> as &quot;MyProtocol&quot;.<p>An application must additionally define an encoding function <em>Encode(PK)</em> to encode an X25519 or X448 public key <em>PK</em> into a byte sequence. The recommended encoding consists of some single-byte constant to represent the type of curve, followed by little-endian encoding of the u-coordinate as specified in <span class="citation">[<a href="#ref-rfc7748">1</a>]</span>.<h2 id="cryptographic-notation">2.2. Cryptographic notation</h2><p>X3DH will use the following notation:<ul><li><p>The concatenation of byte sequences <strong><em>X</em></strong> and <strong><em>Y</em></strong> is <strong><em>X</em></strong> || <strong><em>Y</em></strong>.<li><p><strong><em>DH(PK1, PK2)</em></strong> represents a byte sequence which is the shared secret output from an Elliptic Curve Diffie-Hellman function involving the key pairs represented by public keys <em>PK1</em> and <em>PK2</em>. The Elliptic Curve Diffie-Hellman function will be either the X25519 or X448 function from <span class="citation">[<a href="#ref-rfc7748">1</a>]</span>, depending on the <em>curve</em> parameter.<li><p><strong><em>Sig(PK, M)</em></strong> represents a byte sequence that is an XEdDSA signature on the byte sequence <em>M</em> and verifies with public key <em>PK</em>, and which was created by signing <em>M</em> with <em>PK</em>'s corresponding private key. The signing and verification functions for XEdDSA are specified in<span class="citation">[<a href="#ref-xeddsa">2</a>]</span>.<li><strong><em>KDF(KM)</em></strong> represents 32 bytes of output from the HKDF algorithm <span class="citation">[<a href="#ref-rfc5869">3</a>]</span> with inputs:<ul><li><em>HKDF input key material</em> = <em>F</em> || <em>KM</em>, where <em>KM</em> is an input byte sequence containing secret key material, and <em>F</em> is a byte sequence containing 32 0xFF bytes if <em>curve</em> is X25519, and 57 0xFF bytes if <em>curve</em> is X448. <em>F</em> is used for cryptographic domain separation with XEdDSA <span class="citation">[<a href="#ref-xeddsa">2</a>]</span>.<li><em>HKDF salt</em> = A zero-filled byte sequence with length equal to the <em>hash</em> output length.<li><em>HKDF info</em> = The <em>info</em> parameter from <a href="#x3dh-parameters">Section 2.1</a>.</ul></ul><h2 id="roles">2.3. Roles</h2><p>The X3DH protocol involves three parties: <strong>Alice</strong>, <strong>Bob</strong>, and a <strong>server</strong>.<ul><li><p><strong>Alice</strong> wants to send Bob some initial data using encryption, and also establish a shared secret key which may be used for bidirectional communication.<li><p><strong>Bob</strong> wants to allow parties like Alice to establish a shared key with him and send encrypted data. However, Bob might be offline when Alice attempts to do this. To enable this, Bob has a relationship with some server.<li><p>The <strong>server</strong> can store messages from Alice to Bob which Bob can later retrieve. The server also lets Bob publish some data which the server will provide to parties like Alice. The amount of trust placed in the server is discussed in <a href="#server-trust">Section 4.7</a>.</ul><p>In some systems the server role might be divided amongst multiple entities, but for simplicity we assume a single server that provides the above functions for Alice and Bob.<p><h2 id="keys">2.4. Keys</h2><p>X3DH uses the following elliptic curve public keys:<table><colgroup><col width="14%" /><col width="85%" /><thead><tr class="header"><th align="left">Name<th align="left">Definition<tbody><tr class="odd"><td align="left"><em>IK<sub>A</sub></em><td align="left">Alice's identity key<tr class="even"><td align="left"><em>EK<sub>A</sub></em><td align="left">Alice's ephemeral key<tr class="odd"><td align="left"><em>IK<sub>B</sub></em><td align="left">Bob's identity key<tr class="even"><td align="left"><em>SPK<sub>B</sub></em><td align="left">Bob's signed prekey<tr class="odd"><td align="left"><em>OPK<sub>B</sub></em><td align="left">Bob's one-time prekey</table><p>All public keys have a corresponding private key, but to simplify description we will focus on the public keys.<p>The public keys used within an X3DH protocol run must either all be in X25519 form, or they must all be in X448 form, depending on the <em>curve</em> parameter <span class="citation">[<a href="#ref-rfc7748">1</a>]</span>.<p>Each party has a long-term identity public key (<em>IK<sub>A</sub></em> for Alice, <em>IK<sub>B</sub></em> for Bob).<p>Bob also has a signed prekey <em>SPK<sub>B</sub></em>, which he will change periodically, and a set of one-time prekeys <em>OPK<sub>B</sub></em>, which are each used in a single X3DH protocol run. (&quot;Prekeys&quot; are so named because they are essentially protocol messages which Bob publishes to the server <em>prior</em> to Alice beginning the protocol run).<p>During each protocol run, Alice generates a new ephemeral key pair with public key <em>EK<sub>A</sub></em>.<p>After a successful protocol run Alice and Bob will share a 32-byte secret key <em>SK</em>. This key may be used within some post-X3DH secure communication protocol, subject to the security considerations in <a href="#security-considerations">Section 4</a>.<h1 id="the-x3dh-protocol">3. The X3DH protocol</h1><h2 id="overview">3.1. Overview</h2><p>X3DH has three phases:<ol style="list-style-type: decimal"><li><p>Bob publishes his identity key and prekeys to a server.<li><p>Alice fetches a &quot;prekey bundle&quot; from the server, and uses it to send an initial message to Bob.<li><p>Bob receives and processes Alice's initial message.</ol><p>The following sections explain these phases.<h2 id="publishing-keys">3.2. Publishing keys</h2><p>Bob publishes a set of elliptic curve public keys to the server, containing:<ul><li>Bob's identity key <em>IK<sub>B</sub></em><li>Bob's signed prekey <em>SPK<sub>B</sub></em><li>Bob's prekey signature <em>Sig(IK<sub>B</sub>, Encode(SPK<sub>B</sub>))</em><li>A set of Bob's one-time prekeys (<em>OPK<sub>B</sub><sup>1</sup></em>, <em>OPK<sub>B</sub><sup>2</sup></em>, <em>OPK<sub>B</sub><sup>3</sup></em>, ...)</ul><p>Bob only needs to upload his identity key to the server once. However, Bob may upload new one-time prekeys at other times (e.g. when the server informs Bob that the server's store of one-time prekeys is getting low).<p>Bob will also upload a new signed prekey and prekey signature at some interval (e.g. once a week, or once a month). The new signed prekey and prekey signature will replace the previous values.<p>After uploading a new signed prekey, Bob may keep the private key corresponding to the previous signed prekey around for some period of time, to handle messages using it that have been delayed in transit. Eventually, Bob should delete this private key for forward secrecy (one-time prekey private keys will be deleted as Bob receives messages using them; see <a href="#receiving-the-initial-message">Section 3.4</a>).<h2 id="sending-the-initial-message">3.3. Sending the initial message</h2><p>To perform an X3DH key agreement with Bob, Alice contacts the server and fetches a &quot;prekey bundle&quot; containing the following values:<ul><li>Bob's identity key <em>IK<sub>B</sub></em><li>Bob's signed prekey <em>SPK<sub>B</sub></em><li>Bob's prekey signature <em>Sig(IK<sub>B</sub>, Encode(SPK<sub>B</sub>))</em><li>(Optionally) Bob's one-time prekey <em>OPK<sub>B</sub></em></ul><p>The server should provide one of Bob's one-time prekeys if one exists, and then delete it. If all of Bob's one-time prekeys on the server have been deleted, the bundle will not contain a one-time prekey.<p>Alice verifies the prekey signature and aborts the protocol if verification fails. Alice then generates an ephemeral key pair with public key <em>EK<sub>A</sub></em>.<p>If the bundle does not contain a one-time prekey, she calculates:<div class="code"><p>    DH1 = DH(IK<sub>A</sub>, SPK<sub>B</sub>)<br />     DH2 = DH(EK<sub>A</sub>, IK<sub>B</sub>)<br />     DH3 = DH(EK<sub>A</sub>, SPK<sub>B</sub>)<br />     SK = KDF(DH1 || DH2 || DH3)</div><p>If the bundle <em>does</em> contain a one-time prekey, the calculation is modified to include an additional <em>DH</em>:<div class="code"><p>    DH4 = DH(EK<sub>A</sub>, OPK<sub>B</sub>)<br />     SK = KDF(DH1 || DH2 || DH3 || DH4)</div><p>The following diagram shows the <em>DH</em> calculations between keys. Note that <em>DH1</em> and <em>DH2</em> provide mutual authentication, while <em>DH3</em> and <em>DH4</em> provide forward secrecy.<div class="figure"> <img src="X3DH.png" alt="DH1...DH4" style="width:50.0%" /><p class="caption">DH1...DH4</div><p>After calculating <em>SK</em>, Alice deletes her ephemeral private key and the <em>DH</em> outputs.<p>Alice then calculates an &quot;associated data&quot; byte sequence <em>AD</em> that contains identity information for both parties:<div class="code"><p>    AD = Encode(IK<sub>A</sub>) || Encode(IK<sub>B</sub>)</div><p>Alice may optionally append additional information to <em>AD</em>, such as Alice and Bob's usernames, certificates, or other identifying information.<p>Alice then sends Bob an initial message containing:<ul><li>Alice's identity key <em>IK<sub>A</sub></em><li>Alice's ephemeral key <em>EK<sub>A</sub></em><li>Identifiers stating which of Bob's prekeys Alice used<li>An initial ciphertext encrypted with some AEAD encryption scheme <span class="citation">[<a href="#ref-aead">4</a>]</span> using <em>AD</em> as associated data and using an encryption key which is either <em>SK</em> or the output from some cryptographic PRF keyed by <em>SK</em>.</ul><p>The initial ciphertext is typically the first message in some post-X3DH communication protocol. In other words, this ciphertext typically has two roles, serving as the first message within some post-X3DH protocol, and as part of Alice's X3DH initial message.<p>After sending this, Alice may continue using <em>SK</em> or keys derived from <em>SK</em> within the post-X3DH protocol for communication with Bob, subject to the security considerations in <a href="#security-considerations">Section 4</a>.<h2 id="receiving-the-initial-message">3.4. Receiving the initial message</h2><p>Upon receiving Alice's initial message, Bob retrieves Alice's identity key and ephemeral key from the message. Bob also loads his identity private key, and the private key(s) corresponding to whichever signed prekey and one-time prekey (if any) Alice used.<p>Using these keys, Bob repeats the <em>DH</em> and <em>KDF</em> calculations from the previous section to derive <em>SK</em>, and then deletes the <em>DH</em> values.<p>Bob then constructs the <em>AD</em> byte sequence using <em>IK<sub>A</sub></em> and <em>IK<sub>B</sub></em>, as described in the previous section. Finally, Bob attempts to decrypt the initial ciphertext using <em>SK</em> and <em>AD</em>. If the initial ciphertext fails to decrypt, then Bob aborts the protocol and deletes <em>SK</em>.<p>If the initial ciphertext decrypts successfully the protocol is complete for Bob. Bob deletes any one-time prekey private key that was used, for forward secrecy. Bob may then continue using <em>SK</em> or keys derived from <em>SK</em> within the post-X3DH protocol for communication with Alice, subject to the security considerations in <a href="#security-considerations">Section 4</a>.<h1 id="security-considerations">4. Security considerations</h1><h2 id="authentication">4.1. Authentication</h2><p>Before or after an X3DH key agreement, the parties may compare their identity public keys <em>IK<sub>A</sub></em> and <em>IK<sub>B</sub></em> through some authenticated channel. For example, they may compare public key fingerprints manually, or by scanning a QR code. Methods for doing this are outside the scope of this document.<p>If authentication is not performed, the parties receive no cryptographic guarantee as to who they are communicating with.<h2 id="protocol-replay">4.2. Protocol replay</h2><p>If Alice's initial message doesn't use a one-time prekey, it may be replayed to Bob and he will accept it. This could cause Bob to think Alice had sent him the same message (or messages) repeatedly.<p>To mitigate this, a post-X3DH protocol may wish to quickly negotiate a new encryption key for Alice based on fresh random input from Bob. This is the typical behavior of Diffie-Hellman based ratcheting protocols <span class="citation">[<a href="#ref-doubleratchet">5</a>]</span>.<p>Bob could attempt other mitigations, such as maintaining a blacklist of observed messages, or replacing old signed prekeys more rapidly. Analyzing these mitigations is beyond the scope of this document.<h2 id="replay-and-key-reuse">4.3. Replay and key reuse</h2><p>Another consequence of the replays discussed in the previous section is that a successfully replayed initial message would cause Bob to derive the same <em>SK</em> in different protocol runs.<p>For this reason, any post-X3DH protocol MUST randomize the encryption key before Bob sends encrypted data. For example, Bob could use a DH-based ratcheting protocol to combine <em>SK</em> with a freshly generated <em>DH</em> output to get a randomized encryption key <span class="citation">[<a href="#ref-doubleratchet">5</a>]</span>.<p>Failure to randomize Bob's encryption key may cause catastrophic key reuse.<h2 id="deniability">4.4. Deniability</h2><p>X3DH doesn't give either Alice or Bob a publishable cryptographic proof of the contents of their communication or the fact that they communicated.<p>Like in the OTR protocol <span class="citation">[<a href="#ref-otr">6</a>]</span>, in some cases a third party that has compromised legitimate private keys from Alice or Bob could be provided a communication transcript that appears to be between Alice and Bob and that can only have been created by some other party that also has access to legitimate private keys from Alice or Bob (i.e. Alice or Bob themselves, or someone else who has compromised their private keys).<p>If either party is collaborating with a third party during protocol execution, they will be able to provide proof of their communication to such a third party. This limitation on &quot;online&quot; deniability appears to be intrinsic to the asynchronous setting <span class="citation">[<a href="#ref-unger">7</a>]</span>.<h2 id="signatures">4.5. Signatures</h2><p>It might be tempting to observe that mutual authentication and forward secrecy are achieved by the <em>DH</em> calculations, and omit the prekey signature. However, this would allow a &quot;weak forward secrecy&quot; attack: A malicious server could provide Alice a prekey bundle with forged prekeys, and later compromise Bob's <em>IK<sub>B</sub></em> to calculate <em>SK</em>.<p>Alternatively, it might be tempting to replace the DH-based mutual authentication (i.e. <em>DH1</em> and <em>DH2</em>) with signatures from the identity keys. However, this reduces deniability, increases the size of initial messages, and increases the damage done if ephemeral or prekey private keys are compromised, or if the signature scheme is broken.<h2 id="key-compromise">4.6. Key compromise</h2><p>Compromise of a party's private keys has a disastrous effect on security, though the use of ephemeral keys and prekeys provides some mitigation.<p>Compromise of a party's identity private key allows impersonation of that party to others. Compromise of a party's prekey private keys may affect the security of older or newer <em>SK</em> values, depending on many considerations.<p>A full analysis of all possible compromise scenarios is outside the scope of this document, however a partial analysis of some plausible scenarios is below:<ul><li><p>If one-time prekeys are used for a protocol run then a compromise of Bob's identity key and prekey private keys at some future time will not compromise the older <em>SK</em>, assuming the private key for <em>OPK<sub>B</sub></em> was deleted.<li><p>If one-time prekeys were <em>not</em> used for a protocol run, then a compromise of the private keys for <em>IK<sub>B</sub></em> and <em>SPK<sub>B</sub></em> from that protocol run would compromise the <em>SK</em> that was calculated earlier. Frequent replacement of signed prekeys mitigates this, as does using a post-X3DH ratcheting protocol which rapidly replaces <em>SK</em> with new keys to provide fresh forward secrecy <span class="citation">[<a href="#ref-doubleratchet">5</a>]</span>.<li><p>Compromise of prekey private keys may enable attacks that extend into the future, such as passive calculation of <em>SK</em> values, and impersonation of arbitrary other parties to the compromised party (&quot;key-compromise impersonation&quot;). These attacks are possible until the compromised party replaces his compromised prekeys on the server (in the case of passive attack); or deletes his compromised signed prekey's private key (in the case of key-compromise impersonation).</ul><h2 id="server-trust">4.7. Server trust</h2><p>A malicious server could cause communication between Alice and Bob to fail (e.g. by refusing to deliver messages).<p>If Alice and Bob authenticate each other as in <a href="#authentication">Section 4.1</a>, then the only additional attack available to the server is to refuse to hand out one-time prekeys, causing forward secrecy for <em>SK</em> to depend on the signed prekey's lifetime (as analyzed in the previous section).<p>This reduction in initial forward secrecy could also happen if one party maliciously drains another party's one-time prekeys, so the server should attempt to prevent this, e.g. with rate limits on fetching prekey bundles.<h2 id="identity-binding">4.8. Identity binding</h2><p>Authentication as in <a href="#authentication">Section 4.1</a> does not necessarily prevent an &quot;identity misbinding&quot; or &quot;unknown key share&quot; attack.<p>This results when an attacker (&quot;Charlie&quot;) falsely presents Bob's identity key fingerprint to Alice as his (Charlie's) own, and then either forwards Alice's initial message to Bob, or falsely presents Bob's contact information as his own.<p>The effect of this is that Alice thinks she is sending an initial message to Charlie when she is actually sending it to Bob.<p>To make this more difficult the parties can include more identifying information into <em>AD</em>, or hash more identifying information into the fingerprint, such as usernames, phone numbers, real names, or other identifying information. Charlie would be forced to lie about these additional values, which might be difficult.<p>However, there is no way to reliably prevent Charlie from lying about additional values, and including more identity information into the protocol often brings trade-offs in terms of privacy, flexibility, and user interface. A detailed analysis of these trade-offs is beyond the scope of this document.<h1 id="ipr">5. IPR</h1><p>This document is hereby placed in the public domain.<h1 id="acknowledgements">6. Acknowledgements</h1><p>The X3DH protocol was developed by Moxie Marlinspike and Trevor Perrin.<p>The underlying &quot;Triple DH&quot; key agreement was proposed by Caroline Kudla and Kenny Paterson in <span class="citation">[<a href="#ref-kudla2005">8</a>]</span>, extending the earlier &quot;Double DH&quot; (aka &quot;Protocol 4&quot;) key agreement from Simon Blake-Wilson et al <span class="citation">[<a href="#ref-blakewilson1997">9</a>]</span>. Using signatures in combination with implicitly-authenticated key agreement has been discussed in works like <span class="citation">[<a href="#ref-eckpfs">10</a>]</span> and <span class="citation">[<a href="#ref-joint">11</a>]</span>.<p>Thanks to Mike Hamburg for discussions about identity binding and elliptic curve public keys.<p>Thanks to Nik Unger and Matthew Green for discussions about deniability.<p>Thanks to Matthew Green, Tom Ritter, Joseph Bonneau, and Benedikt Schmidt for editorial feedback.<h1 id="references" class="unnumbered">7. References</h1><div id="refs" class="references"><div id="ref-rfc7748"><p>[1] A. Langley, M. Hamburg, and S. Turner, “Elliptic Curves for Security.” Internet Engineering Task Force; RFC 7748 (Informational); IETF, Jan-2016. <a href="http://www.ietf.org/rfc/rfc7748.txt" class="uri">http://www.ietf.org/rfc/rfc7748.txt</a></div><div id="ref-xeddsa"><p>[2] T. Perrin, “The XEdDSA and VXEdDSA Signature Schemes,” 2016. <a href="https://whispersystems.org/docs/specifications/xeddsa/" class="uri">https://whispersystems.org/docs/specifications/xeddsa/</a></div><div id="ref-rfc5869"><p>[3] H. Krawczyk and P. Eronen, “HMAC-based Extract-and-Expand Key Derivation Function (HKDF).” Internet Engineering Task Force; RFC 5869 (Informational); IETF, May-2010. <a href="http://www.ietf.org/rfc/rfc5869.txt" class="uri">http://www.ietf.org/rfc/rfc5869.txt</a></div><div id="ref-aead"><p>[4] P. Rogaway, “Authenticated-encryption with Associated-data,” in Proceedings of the 9th ACM Conference on Computer and Communications Security, 2002. <a href="http://web.cs.ucdavis.edu/~rogaway/papers/ad.pdf" class="uri">http://web.cs.ucdavis.edu/~rogaway/papers/ad.pdf</a></div><div id="ref-doubleratchet"><p>[5] T. Perrin, “The Double Ratchet Algorithm (work in progress),” 2016.</div><div id="ref-otr"><p>[6] N. Borisov, I. Goldberg, and E. Brewer, “Off-the-record Communication, or, Why Not to Use PGP,” in Proceedings of the 2004 aCM workshop on privacy in the electronic society, 2004. <a href="http://doi.acm.org/10.1145/1029179.1029200" class="uri">http://doi.acm.org/10.1145/1029179.1029200</a></div><div id="ref-unger"><p>[7] N. Unger and I. Goldberg, “Deniable Key Exchanges for Secure Messaging,” in Proceedings of the 22Nd aCM sIGSAC conference on computer and communications security, 2015. <a href="http://doi.acm.org/10.1145/2810103.2813616" class="uri">http://doi.acm.org/10.1145/2810103.2813616</a></div><div id="ref-kudla2005"><p>[8] C. Kudla and K. G. Paterson, “Modular Security Proofs for Key Agreement Protocols,” in Advances in Cryptology - ASIACRYPT 2005: 11th International Conference on the Theory and Application of Cryptology and Information Security, 2005. <a href="http://www.isg.rhul.ac.uk/~kp/ModularProofs.pdf" class="uri">http://www.isg.rhul.ac.uk/~kp/ModularProofs.pdf</a></div><div id="ref-blakewilson1997"><p>[9] S. Blake-Wilson, D. Johnson, and A. Menezes, “Key agreement protocols and their security analysis,” in Crytography and Coding: 6th IMA International Conference Cirencester, UK, December 17–19, 1997 Proceedings, 1997. <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.25.387" class="uri">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.25.387</a></div><div id="ref-eckpfs"><p>[10] C. Cremers and M. Feltz, “One-round Strongly Secure Key Exchange with Perfect Forward Secrecy and Deniability.” Cryptology ePrint Archive, Report 2011/300, 2011. <a href="http://eprint.iacr.org/2011/300" class="uri">http://eprint.iacr.org/2011/300</a></div><div id="ref-joint"><p>[11] J. P. Degabriele, A. Lehmann, K. G. Paterson, N. P. Smart, and M. Strefler, “On the Joint Security of Encryption and Signature in EMV.” Cryptology ePrint Archive, Report 2011/615, 2011. <a href="http://eprint.iacr.org/2011/615" class="uri">http://eprint.iacr.org/2011/615</a></div></div></div></div><div class="columns is-centered"><div class="column is-3"></div><div class="column is-6"><h3>Want to get involved with Open Whisper Systems? <a href="../../../workworkwork/index.html">We're hiring!</a></h3></div><div class="column is-3"></div></div></div></article></section><footer class="footer"><div class="container"><div class="columns"><div class="column is-two-fifths is-hidden-mobile"> <span class="copyright">&copy; 2013&ndash;2020 Bitorzo, a 501c3 nonprofit.</span><br /> Signal is a registered trademark in the United States and other countries.</div><div class="column"> <strong>Company</strong><ul><li> <a href="../../../donate/index.html">Donate</a><li> <a href="../../../workworkwork/index.html">Careers</a><li> <a href="../../../blog/index.html">Blog</a><li> <a href="../../../legal/index.html">Terms &amp; Privacy Policy</a></ul></div><div class="column"> <strong>Download</strong><ul><li> <a href="../../../download/android/index.html">Android</a><li> <a href="../../../download/ios/index.html">iPhone & iPad</a><li> <a href="../../../download/windows/index.html">Windows</a><li> <a href="../../../download/macos/index.html">Mac</a><li> <a href="../../../download/linux/index.html">Linux</a></ul></div><div class="column"> <strong>Social</strong><ul><li> <a href="https://github.com/Bitorzo" target="_blank">Github</a><li> <a href="https://twitter.com/Bitorzo" target="_blank">Twitter</a><li> <a href="https://www.instagram.com/signal_app/" target="_blank">Instagram</a></ul></div><div class="column"> <strong>Help</strong><ul><li> <a href="https://support.Bitorzo/">Support</a><li> <a href="https://community.signalusers.org/">Community</a></ul></div><div class="column is-two-fifths is-hidden-tablet"> <span class="copyright">&copy; 2013&ndash;2020 Bitorzo, a 501c3 nonprofit.</span><br /> Signal is a registered trademark in the United States and other countries.</div></div></div></footer><script type="text/javascript" src="../../../assets/vendor/jquery-3.5.1.min-a6ed45d15e46615f8c15931ca254e398a912e770b10122a4435529a1a523180d.js"></script> <script type="text/javascript" src="../../../assets/vendor/lottie-player-0.5.1.min-7b15c2adfdb246be3414fb8d6966f54c06cc82f090a5d23c77f079de4c16fef3.js"></script> <script type="text/javascript"> const $langSelectors = Array.prototype.slice.call(document.querySelectorAll('a[data-lang]')); $langSelectors.forEach((el) => { el.addEventListener('click', (ev) => { const lang = ev.getAttribute('data-lang'); if (lang) { document.cookie = 'selected_language=' + lang + '; samesite; secure; path=/; max-age=7776000;'; } }); }); document.addEventListener('DOMContentLoaded', () => { var userAgent = navigator.userAgent.toLowerCase(); var isIOS = ( userAgent.indexOf('iphone') !== -1 || userAgent.indexOf('ipad') !== -1 || userAgent.indexOf('ipod') !== -1 ); var isAndroid = userAgent.indexOf('android') !== -1; var $downloadSignal = $('.get-signal'); if (isIOS || isAndroid) { var url = isIOS ? 'https://play.google.com/store/apps/details?id=com.bitorzo.wallet' : 'https://play.google.com/store/apps/details?id=org.thoughtcrime.securesms'; $downloadSignal.prop('href', url); $downloadSignal.html('<span>Get Bitorzo</span> <i class="fas fa-external-link-alt"></i>'); } const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger')); if ($navbarBurgers.length > 0) { $navbarBurgers.forEach((el) => { el.addEventListener('click', () => { const target = el.dataset.target; const $target = document.getElementById(target); el.classList.toggle('is-active'); $target.classList.toggle('is-active'); }); }); } }); </script> <script type="text/javascript"> var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101071404); (function() { var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://static.getclicky.com/js'; ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s ); })(); </script> <noscript><p><img width="1" height="1" src="../../../../in.getclicky.com/101071404ns.gif" /></noscript>
